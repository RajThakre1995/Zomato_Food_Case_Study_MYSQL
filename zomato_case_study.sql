CREATE DATABASE ZOMATO;

USE ZOMATO;

SELECT * FROM CUSTOMERS;
SELECT * FROM DELIVERIES;
SELECT * FROM ITEMS;
SELECT * FROM ORDERS;
SELECT * FROM RESTAURANTS;

-- What is the total number of orders placed?

SELECT COUNT(*) AS TOTAL_NUMBERS_OF_ORDERS FROM ORDERS;

-- How many orders were delivered successfully?

SELECT COUNT(*) AS DELIVERED_ORDERS FROM ORDERS
WHERE STATUS='DELIVERED';

-- What is the average order amount?

SELECT AVG(TOTAL_AMOUNT) AS AVG_ORDER_AMOUNT FROM ORDERS;

-- Which restaurant has the highest rating?

SELECT * FROM RESTAURANTS
ORDER BY RATING DESC
LIMIT 1;

-- Retrieve the top 5 highest value orders.

SELECT * FROM ORDERS
ORDER BY TOTAL_AMOUNT DESC
LIMIT 5;

-- Which customer has placed the maximum number of orders?

SELECT CUSTOMER_ID,COUNT(*) AS TOTAL_ORDERS FROM ORDERS
GROUP BY CUSTOMER_ID
ORDER BY TOTAL_ORDERS DESC
LIMIT 1;

-- What is the percentage of cancelled orders?
SELECT 
	CONCAT(ROUND((COUNT(CASE
		WHEN STATUS='CANCELLED' THEN 1 END)/COUNT(*))*100,2),'%')
        AS CANCELLED_PERCENTAGE
        FROM ORDERS;

-- What is the average delivery time across all orders?

SELECT AVG(DELIVERY_TIME) AS AVG_DELIVERY_TIME FROM DELIVERIES;

-- List all restaurants with a rating above 4.0.

SELECT * FROM RESTAURANTS
WHERE RATING>4;

-- Which city has the highest number of customers?

SELECT LOCATION,COUNT(*) AS NUMBERS_OF_CUSTOMERS FROM RESTAURANTS
GROUP BY LOCATION
ORDER BY NUMBERS_OF_CUSTOMERS DESC
LIMIT 1;

-- Calculate the total revenue generated by each restaurant.
SELECT
	R.RESTAURANT_ID,
    R.NAME,
    ROUND(SUM(O.TOTAL_AMOUNT),2) AS TOTAL_REVENUE
    FROM RESTAURANTS AS R
    JOIN ORDERS AS O
    ON R.RESTAURANT_ID = O.RESTAURANT_ID
    WHERE O.STATUS = 'DELIVERED'
	GROUP BY R.RESTAURANT_ID,R.NAME;
    

-- Which cuisine type generates the highest total revenue?
SELECT
	R.CUISINE_TYPE,
    ROUND(SUM(O.TOTAL_AMOUNT),2) AS TOTAL_REVENUE
    FROM RESTAURANTS AS R 
    JOIN ORDERS AS O
    ON R.RESTAURANT_ID = O.RESTAURANT_ID
    WHERE O.STATUS = 'DELIVERED'
    GROUP BY R.CUISINE_TYPE
    ORDER BY TOTAL_REVENUE DESC
    LIMIT 1;

-- What is the average order amount per city?
SELECT
	R.LOCATION,
    ROUND(AVG(O.TOTAL_AMOUNT),2) AS AVG_ORDER_AMOUNT
    FROM RESTAURANTS AS R
    JOIN ORDERS AS O
    ON R.RESTAURANT_ID = O.RESTAURANT_ID
    GROUP BY R.LOCATION;

-- Which restaurant has the fastest average delivery time?
SELECT
	R.RESTAURANT_ID,
    R.NAME,
    ROUND(AVG(D.DELIVERY_TIME),2) AS AVG_DELIVERY_TIME
    FROM DELIVERIES AS D
    JOIN ORDERS AS O
    ON D.ORDER_ID = O.ORDER_ID
    JOIN RESTAURANTS AS R 
    ON O.RESTAURANT_ID = R.RESTAURANT_ID
    GROUP BY R.RESTAURANT_ID,R.NAME
	ORDER BY AVG_DELIVERY_TIME ASC
    LIMIT 1;
    
-- Calculate the total spending of each customer.
SELECT
	C.CUSTOMER_ID,
    C.NAME,
    ROUND(SUM(O.TOTAL_AMOUNT),2) AS TOTAL_SPENDING
    FROM CUSTOMERS AS C
    JOIN ORDERS AS O
    ON C.CUSTOMER_ID = O.CUSTOMER_ID
    WHERE O.STATUS = 'DELIVERED'
    GROUP BY C.CUSTOMER_ID,C.NAME
    ORDER BY TOTAL_SPENDING DESC;

-- Identify the top 5 customers based on total spending.

SELECT
	C.CUSTOMER_ID,
    C.NAME,
    ROUND(SUM(O.TOTAL_AMOUNT),2) AS TOTAL_SPENDING
    FROM CUSTOMERS AS C
    JOIN ORDERS AS O
    ON C.CUSTOMER_ID = O.CUSTOMER_ID
    WHERE O.STATUS = 'DELIVERED'
    GROUP BY C.CUSTOMER_ID,C.NAME
    ORDER BY TOTAL_SPENDING DESC
    LIMIT 5;

-- Retrieve orders where delivery time exceeded 60 minutes.

SELECT * FROM DELIVERIES
	WHERE DELIVERY_TIME>60;

-- Analyze the relationship between delivery distance and delivery fee.

SELECT ROUND(AVG(DELIVERY_FEE/DISTANCE_KM),2) AS AVG_FEE_PER_KM FROM DELIVERIES;

-- Which restaurants have the highest number of repeat customers?
SELECT
	R.RESTAURANT_ID,
    R.NAME,
    COUNT(DISTINCT O.CUSTOMER_ID) AS UNIQUE_CUSTOMERS
    FROM RESTAURANTS AS R
    JOIN ORDERS AS O
    ON R.RESTAURANT_ID = O.RESTAURANT_ID
    GROUP BY R.RESTAURANT_ID,R.NAME
    ORDER BY UNIQUE_CUSTOMERS DESC;

-- Provide revenue breakdown by order status.
SELECT
	STATUS,SUM(TOTAL_AMOUNT) AS TOTAL_REVENUE
    FROM ORDERS
    GROUP BY STATUS;
    
-- Identify the highest revenue-generating restaurant in each city.

WITH CTE AS (SELECT
	R.LOCATION,
    R.RESTAURANT_ID,
    R.NAME,
    ROUND(SUM(O.TOTAL_AMOUNT),2) AS TOTAL_REVENUE,
    DENSE_RANK() OVER (PARTITION BY R.LOCATION ORDER BY ROUND(SUM(O.TOTAL_AMOUNT),2) DESC) AS RK
    FROM RESTAURANTS AS R 
    JOIN ORDERS AS O
    ON R.RESTAURANT_ID = O.RESTAURANT_ID
    WHERE O.STATUS = 'DELIVERED'
    GROUP BY R.LOCATION,R.RESTAURANT_ID,R.NAME)
    
    SELECT * FROM CTE
    WHERE RK=1;

-- Find the top 3 restaurants by revenue within each cuisine type.
WITH CTE AS (
SELECT
	R.CUISINE_TYPE,
    R.RESTAURANT_ID,
    R.NAME,
    ROUND(SUM(O.TOTAL_AMOUNT),2) AS TOTAL_REVENUE,
    DENSE_RANK() OVER (PARTITION BY R.CUISINE_TYPE ORDER BY ROUND(SUM(O.TOTAL_AMOUNT),2) DESC) AS RK
    FROM RESTAURANTS AS R
    JOIN ORDERS AS O
    ON R.RESTAURANT_ID = O.RESTAURANT_ID
    WHERE O.STATUS = 'DELIVERED'
    GROUP BY R.CUISINE_TYPE,R.RESTAURANT_iD,R.NAME)
    
    SELECT * FROM CTE
    WHERE RK<=3;

-- Calculate monthly revenue trends.
SELECT
	DATE_FORMAT(ORDER_DATE,'%Y-%m') AS MONTHH,
    ROUND(SUM(TOTAL_AMOUNT),2) AS TOTAL_REVENUE
    FROM ORDERS
    WHERE STATUS = 'DELIVERED'
    GROUP BY DATE_FORMAT(ORDER_DATE,'%Y-%m')
    ORDER BY MONTHH;

-- Which restaurant has the highest cancellation rate?
SELECT
	R.RESTAURANT_ID,
    R.NAME,
    SUM(CASE WHEN O.STATUS = 'CANCELLED' THEN 1 ELSE 0 END)*100/COUNT(*) AS CANCELLATION_RATE
    FROM ORDERS AS O
    JOIN RESTAURANTS AS R
    ON O.RESTAURANT_ID = R.RESTAURANT_ID
    GROUP BY R.RESTAURANT_ID,R.NAME
    ORDER BY CANCELLATION_RATE DESC
    LIMIT 1;

-- Identify high-rated (4+) restaurants with comparatively low revenue.
SELECT
	R.RESTAURANT_ID,
    R.NAME,
    ROUND(SUM(O.TOTAL_AMOUNT),2) AS TOTAL_REVENUE
    FROM RESTAURANTS AS R 
    JOIN ORDERS AS O
    ON R.RESTAURANT_ID = O.RESTAURANT_ID
    WHERE R.RATING >= 4
    GROUP BY R.RESTAURANT_ID,R.NAME
    HAVING ROUND(SUM(O.TOTAL_AMOUNT),2) < (SELECT AVG(TOTAL_AMOUNT) FROM ORDERS);

-- Calculate Customer Lifetime Value (CLV).

SELECT
	CUSTOMER_ID,
    ROUND(SUM(TOTAL_AMOUNT),2) AS LIFETIME_VALUE
    FROM ORDERS
    WHERE STATUS = 'DELIVERED'
    GROUP BY CUSTOMER_ID
	ORDER BY LIFETIME_VALUE DESC;
    
-- Compare calculated item total (price Ã— quantity) with order total amount.

SELECT
	O.ORDER_ID,
    O.TOTAL_AMOUNT,
    SUM(I.PRICE*I.QUANTITY) AS CALCULATED_TOTAL
    FROM ORDERS AS O
    JOIN ITEMS AS I 
    ON O.ORDER_ID = I.ORDER_ID
    GROUP BY O.ORDER_ID,O.TOTAL_AMOUNT;
    

-- Does restaurant rating impact average delivery time?
SELECT
	R.RATING,
    ROUND(AVG(D.DELIVERY_TIME),2) AS AVG_DELIVERY_TIME
    FROM RESTAURANTS AS R 
    JOIN ORDERS AS O
    ON R.RESTAURANT_ID = O.RESTAURANT_ID
    JOIN DELIVERIES AS D 
    ON O.ORDER_ID = D.ORDER_ID
    GROUP BY R.RATING
    ORDER BY R.RATING DESC;

-- Which restaurant shows the highest growth in the last 30 days?

SELECT
	R.RESTAURANT_ID,
    R.NAME,
    ROUND(SUM(O.TOTAL_AMOUNT),2) AS REVENUE_LAST_30_DAYS
    FROM RESTAURANTS AS R 
    JOIN ORDERS AS O
    ON R.RESTAURANT_ID = O.RESTAURANT_ID
    WHERE O.ORDER_DATE>=DATE_SUB((SELECT MAX(ORDER_DATE) FROM ORDERS),INTERVAL 30 DAY) AND O.STATUS = 'DELIVERED'
    GROUP BY R.RESTAURANT_ID,R.NAME
    ORDER BY REVENUE_LAST_30_DAYS DESC
    LIMIT 1;

-- Identify delivery fee per kilometer and detect outliers.

SELECT DELIVERY_ID,
	DELIVERY_FEE / DISTANCE_KM AS FEE_PER_KM
	FROM DELIVERIES
	ORDER BY FEE_PER_KM DESC;


